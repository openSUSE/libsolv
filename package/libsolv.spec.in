#
# spec file for package libsolv
#
# Copyright (c) 2018 SUSE LINUX GmbH, Nuernberg, Germany.
#
# All modifications and additions to the file contributed by third parties
# remain the property of their copyright owners, unless otherwise agreed
# upon. The license for this file, and modifications and additions to the
# file, is the same license as for the pristine package itself (unless the
# license for the pristine package is not an Open Source License, in which
# case the license is the MIT License). An "Open Source License" is a
# license that conforms to the Open Source Definition (Version 1.9)
# published by the Open Source Initiative.

# Please submit bugfixes or comments via http://bugs.opensuse.org/
#


%define libname libsolv@LIBSOLV_SOVERSION@
# Helper macros for systems where not defined
%if ! %{defined _ctest}
%if 0%{?suse_version} || 0%{?mageia}
%global cmake_install cd build && make DESTDIR=%{buildroot} install
%global ctest cd build && %{_bindir}/ctest %{?_smp_mflags}
%else
%global cmake_install make DESTDIR=%{buildroot} install
%global ctest %{_bindir}/ctest %{?_smp_mflags}
%endif
%endif
%{!?python2_sitearch:%global python2_sitearch %{python_sitearch}}
%{!?rb_vendorlibdir:%global rb_vendorlibdir %{ruby_vendorarchdir}}
%if 0%{?sle_version} >= 120300 || 0%{?suse_version} >= 1500 || 0%{?fedora} || 0%{?mageia} > 6 || 0%{?rhel} > 7
%bcond_without bz2
%bcond_without xz
%else
%bcond_with bz2
%bcond_with xz
%endif
%if 0%{?fedora} || 0%{?rhel} >= 7 || 0%{?mageia} >= 6 || 0%{?suse_version} >= 1330
%bcond_without richdeps
%else
%bcond_with richdeps
%endif
%if 0%{?suse_version} >= 1310 || 0%{?fedora} || 0%{?rhel} > 7 || 0%{?mageia} >= 6
%bcond_without python3
%else
%bcond_with python3
%endif
%if 0%{?rhel} || 0%{?suse_version} < 1120
%bcond_with ruby
%bcond_with perl
%else
%bcond_without ruby
%bcond_without perl
%endif
%if 0%{?suse_version} < 1120
%bcond_with python2
%else
%bcond_without python2
%endif
%bcond_without static
%bcond_with shared
%if 0%{?suse_version}
%bcond_without zypp
%else
%bcond_with zypp
%endif
Name:           libsolv
Version:        @VERSION@
Release:        0
Summary:        Package dependency solver using a satisfiability algorithm
License:        BSD-3-Clause
Group:          Development/Libraries/C and C++
URL:            https://github.com/openSUSE/libsolv
Source:         libsolv-%{version}.tar.bz2
BuildRequires:  cmake
BuildRequires:  gcc-c++
BuildRequires:  libxml2-devel
BuildRequires:  pkgconfig
BuildRequires:  rpm-devel
BuildRequires:  zlib-devel
BuildRoot:      %{_tmppath}/%{name}-%{version}-build
%if %{with ruby}
BuildRequires:  ruby
BuildRequires:  ruby-devel
BuildRequires:  swig
%endif
%if 0%{?fedora} || 0%{?rhel}
BuildRequires:  libdb-devel
%endif
%if 0%{?mageia}
BuildRequires:  db-devel
%endif
%if %{with perl}
BuildRequires:  perl
BuildRequires:  swig
%endif
%if %{with python2}
BuildRequires:  python-devel
BuildRequires:  swig
%endif
%if %{with python3}
BuildRequires:  swig
BuildRequires:  pkgconfig(python3)
%endif
%if %{with bz2}
BuildRequires:  pkgconfig(bzip2)
%endif
%if %{with xz}
BuildRequires:  pkgconfig(liblzma)
%endif

%description
libsolv is a library for solving packages and reading repositories.
The solver uses a satisfiability algorithm.

%if %{with shared}
%package -n %{libname}
Summary:        Package dependency solver using a satisfiability algorithm
Group:          System/Libraries

%description -n %{libname}
libsolv is a library for solving packages and reading repositories.
It consists of two central blocks: Using a dictionary approach to
store and retrieve package and dependency information, and, using a
so-called satisfiability algorithm for resolving package
dependencies.
%endif

%package devel
Summary:        Development files for libsolv, a package solver
Group:          Development/Libraries/C and C++
Requires:       rpm-devel
Conflicts:      libsatsolver-devel
%if %{with shared}
Requires:       %{libname} = %{version}-%{release}
%endif

%description devel
Development files for libsolv, a library for solving packages and
reading repositories.

%package tools
Summary:        Utilities to work with .solv files
Group:          System/Management
Requires:       bzip2
Requires:       coreutils
Requires:       findutils
Requires:       gzip
Conflicts:      satsolver-tools-obsolete
Obsoletes:      satsolver-tools < 0.18
Provides:       satsolver-tools = 0.18

%description tools
libsolv is a library for solving packages and reading repositories.

This subpackage contains utilities to create and work with the .solv
files used by libsolv.

%package demo
Summary:        Applications demoing the libsolv library
Group:          System/Management
Requires:       curl
Conflicts:      libsatsolver-demo
%if 0%{?fedora} || 0%{?rhel} >= 6 || 0%{?mageia}
Requires:       gnupg2
%endif
%if 0%{?suse_version}
Requires:       gpg2
%endif

%description demo
Applications demoing the libsolv library.

%package -n ruby-solv
Summary:        Ruby bindings for the libsolv library
Group:          Development/Languages/Ruby

%description -n ruby-solv
Ruby bindings for libsolv.

%package -n python-solv
Summary:        Python bindings for the libsolv library
Group:          Development/Languages/Python

%description -n python-solv
Python bindings for libsolv.

%package -n python3-solv
Summary:        Python3 bindings for the libsolv library
Group:          Development/Languages/Python

%description -n python3-solv
Python3 bindings for libsolv.

%package -n perl-solv
Summary:        Perl bindings for the libsolv library
Group:          Development/Languages/Perl
Requires:       perl = %{perl_version}

%description -n perl-solv
Perl bindings for libsolv.

%prep
%setup -q

%build
export CFLAGS="%{optflags}"
export CXXFLAGS="$CFLAGS"

CMAKE_FLAGS=
%if 0%{?fedora} || 0%{?rhel}
CMAKE_FLAGS="-DFEDORA=1"
%endif
%if 0%{?mageia}
CMAKE_FLAGS="-DMAGEIA=1"
%endif
%if 0%{?suse_version}
CMAKE_FLAGS="-DSUSE=1"
%endif

# SHARE/MODULE flags in SUSE enforce no-undefined which is not applicable for
# bindings here
%cmake $CMAKE_FLAGS \
	-DCMAKE_MODULE_LINKER_FLAGS="-Wl,--as-needed -Wl,-z,now" \
	-DCMAKE_SHARED_LINKER_FLAGS="-Wl,--as-needed -Wl,-z,now" \
	-DWITH_LIBXML2=1 \
	-DENABLE_APPDATA=1 \
	-DENABLE_COMPS=1 \
	%{?with_static:-DENABLE_STATIC=1} \
	%{!?with_shared:-DDISABLE_SHARED=1} \
	%{?with_perl:-DENABLE_PERL=1} \
	%{?with_python2:-DENABLE_PYTHON=1} \
	%{?with_python3:-DENABLE_PYTHON3=1} \
	%{?with_ruby:-DENABLE_RUBY=1} \
	%{?with_bz2:-DENABLE_BZIP2_COMPRESSION=1} \
	%{?with_xz:-DENABLE_LZMA_COMPRESSION=1} \
	%{?with_richdeps:-DENABLE_COMPLEX_DEPS=1} \
	%{?with_zypp:-DENABLE_SUSEREPO=1 -DENABLE_HELIXREPO=1} \
	-DUSE_VENDORDIRS=1
make %{?_smp_mflags}

%install
%cmake_install

%if 0%{?suse_version}
%if %{with python2}
%py_compile %{buildroot}/%{python2_sitearch}
%endif
%if %{with python3}
%py3_compile %{buildroot}/%{python3_sitearch}
%endif
%endif
%if %{with static}
# we want to leave the .a file untouched
export NO_BRP_STRIP_DEBUG=true
%endif

%check
%ctest

%if %{with shared}
%post -n %{libname} -p /sbin/ldconfig
%postun -n %{libname} -p /sbin/ldconfig

%files -n %{libname}
%defattr(-,root,root)
%doc LICENSE*
%{_libdir}/libsolv.so.*
%{_libdir}/libsolvext.so.*
%endif

# Some small macro to list tools with mans
%global solv_tool() \
%{_bindir}/%{1} \
%{_mandir}/man1/%{1}.1* \
%{nil}

%files tools
%defattr(-,root,root)
%doc LICENSE*
%solv_tool appdata2solv
%solv_tool comps2solv
%solv_tool deltainfoxml2solv
%solv_tool dumpsolv
%solv_tool installcheck
%solv_tool mergesolv
%solv_tool repomdxml2solv
%solv_tool rpmdb2solv
%solv_tool rpmmd2solv
%solv_tool rpms2solv
%solv_tool testsolv
%solv_tool updateinfoxml2solv
%if %{with zypp}
  %solv_tool susetags2solv
%endif
%{_bindir}/repo2solv.sh

%files devel
%defattr(-,root,root)
%doc LICENSE*
%if %{with static}
%{_libdir}/libsolv.a
%{_libdir}/libsolvext.a
%endif
%if %{with shared}
%{_libdir}/libsolv.so
%{_libdir}/libsolvext.so
%endif
%{_includedir}/solv
%{_datadir}/cmake/Modules/*
%{_libdir}/pkgconfig/libsolv*.pc
%{_mandir}/man3/*
%if %{with zypp}
  %solv_tool helix2solv
%endif

%files demo
%defattr(-,root,root)
%{_bindir}/solv

%if %{with perl}
%files -n perl-solv
%defattr(-,root,root)
%{perl_vendorarch}/*
%endif

%if %{with ruby}
%files -n ruby-solv
%defattr(-,root,root)
%{rb_vendorlibdir}/*
%endif

%if %{with python2}
%files -n python-solv
%defattr(-,root,root)
%{python2_sitearch}/*
%endif

%if %{with python3}
%files -n python3-solv
%defattr(-,root,root)
%{python3_sitearch}/*
%endif

%changelog
